{% set cat_map = {} %}
{% for s in seats %}
  {% set cid = s.category_id %}
  {% if cat_map.get(cid) is none %}
    {% set _ = cat_map.update({cid: []}) %}
  {% endif %}
  {% set _ = cat_map[cid].append(s) %}
{% endfor %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seat Map â€“ Show {{ show_id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0e1116; --panel: #161a22; --text: #e6edf3; --muted: #9ca3af;
      --available: #10b981; --locked: #f59e0b; --mine: #3b82f6; --booked: #ef4444; --border: #2a2f3a;
      --accent: #22c55e; --accent-2: #2563eb;
    }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; }
    .container { max-width: 1100px; margin: 20px auto 100px; padding: 0 12px; }

    .venue-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
    .venue-title { font-weight: 700; font-size: 18px; }
    .meta { color: var(--muted); font-size: 13px; }

    .legend { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; font-size: 13px; color: var(--muted); }
    .dot { width: 14px; height: 14px; border-radius: 4px; display: inline-block; margin-right: 6px; vertical-align: middle; }
    .legend .available { background:#0a1a14; border:1px solid #1e293b }
    .legend .mine { background:#0a162b; border:1px solid #1e3a8a }
    .legend .locked { background:#1d1606; border:1px solid #92400e }
    .legend .booked { background:#1f0c0c; border:1px solid #7f1d1d }
    .legend .walkway { background:#0b0f14; border:1px dashed var(--border) }

    .screen { text-align:center; padding: 6px; color: var(--muted); font-weight: 600; border-bottom: 1px dashed var(--border); margin: 8px 0 12px; }
    .section { background: var(--panel); border:1px solid var(--border); border-radius: 12px; margin-bottom: 14px; overflow: hidden; }
    .section-header { display:flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #10151d; border-bottom:1px solid var(--border); }
    .section-title { font-weight: 700; }
    .price { color: var(--muted); font-size: 14px; }

    .seat-rows { padding: 12px; display: grid; gap: 10px; }
    .row { display: grid; grid-template-columns: 36px 1fr; align-items: center; gap: 8px; }
    .row-label { width: 36px; color: var(--muted); text-align: right; padding-right: 6px; }
    .row-seats { display: grid; grid-auto-flow: column; grid-auto-columns: 44px; gap: 8px; }

    .seat {
      height: 44px; border-radius: 10px; border: 1px solid var(--border);
      display:flex; align-items:center; justify-content:center; font-weight:600; cursor:pointer; user-select:none;
      transition: transform 0.05s ease, box-shadow 0.15s ease, filter 0.15s ease;
    }
    .seat.available { background: #0a1a14; color: var(--available); }
    .seat.available:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(16,185,129,0.15); }
    .seat.locked { background: #1d1606; color: var(--locked); cursor: not-allowed; filter: saturate(0.8); }
    .seat.mine { background: #0a162b; color: var(--mine); box-shadow: inset 0 0 0 1px #1e40af; }
    .seat.booked { background: #1f0c0c; color: var(--booked); cursor: not-allowed; filter: grayscale(0.2) contrast(1.05); }

    .walkway {
      width: 44px; height: 44px; border-radius: 10px;
      border: 1px dashed var(--border);
      background: #0b0f14;
      opacity: 0;
      pointer-events: none;
      
    }

    .bottom-bar {
      position: fixed; left: 0; right: 0; bottom: 0; background: #0b0f14; border-top: 1px solid var(--border);
      padding: 12px 16px; display:flex; justify-content: space-between; align-items: center; gap: 12px;
    }
    .selected { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .pill { background: #0f172a; border:1px solid #1f2937; padding: 6px 10px; border-radius: 999px; font-size: 13px; }
    .btn { background: var(--accent-2); border:1px solid #1d4ed8; color: white; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 700; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <div class="venue-header">
      <div>
        <div class="venue-title">Choose Seats</div>
        <div class="meta">Show #{{ show_id }}</div>
      </div>
      <div class="legend">
        <span><span class="dot available"></span>Available</span>
        <span><span class="dot mine"></span>Selected</span>
        <span><span class="dot locked"></span>Locked (other)</span>
        <span><span class="dot booked"></span>Booked</span>
        <span><span class="dot walkway"></span>Walkway</span>
      </div>
    </div>

    <div class="screen">SCREEN</div>

    {% for cat in categories %}
      {% set cat_seats = cat_map.get(cat.category_id, []) %}
      <div class="section" data-category-id="{{ cat.category_id }}" data-category-name="{{ cat.category_name }}" data-category-price="{{ cat.price }}">
        <div class="section-header">
          <div class="section-title">{{ cat.category_name }}</div>
          <div class="price">Rs {{ '%.0f'|format(cat.price) }}</div>
        </div>

        {% if cat_seats %}
          {% set rows = {} %}
          {% for s in cat_seats %}
            {% set rn = s.row_number %}
            {% if rows.get(rn) is none %}
              {% set _ = rows.update({rn: []}) %}
            {% endif %}
            {% set _ = rows[rn].append(s) %}
          {% endfor %}

          <div class="seat-rows">
            {% for rn, row_seats in rows|dictsort %}
              {% set rn_int = rn|int %}
              {% set row_label = ('ABCDEFGHIJKLMNOPQRSTUVWXYZ'[rn_int - 1] if 1 <= rn_int <= 26 else 'R' ~ rn_int) %}
              <div class="row" data-row="{{ rn }}">
                <div class="row-label">{{ row_label }}</div>
                <div class="row-seats">
                  {# Render seats or walkway tiles #}
                  {% for seat in row_seats|sort(attribute='col_number') %}
                    {# A tile is a walkway iff seat_number is missing OR is_available is explicitly false #}
                    {% set walkway = (seat.seat_number is none) or (seat.seat_number == '') or (seat.is_available is sameas false) %}

                    {% if not walkway %}
                      {% set state = 'available' %}
                      {% if seat.seat_id in booked_ids %}
                        {% set state = 'booked' %}
                      {% else %}
                        {% for l in locks %}
                          {% if l.seat_id == seat.seat_id %}
                            {% set state = ('mine' if l.user_id == user_id else 'locked') %}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                      <div class="seat {{ state }}"
                           data-seat-id="{{ seat.seat_id }}"
                           data-seat-number="{{ seat.seat_number }}"
                           data-category-id="{{ seat.category_id }}"
                           data-price="{{ seat.price or cat.price }}"
                      >{{ seat.seat_number }}</div>
                    {% else %}
                      <div class="walkway" aria-hidden="true" title="Walkway"></div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div style="padding:12px;color:#9ca3af;font-size:13px;">No seats for this category.</div>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <div class="bottom-bar">
    <div class="selected" id="selectedInfo">
      <span class="meta">0 seats selected</span>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <div id="total" class="pill">Total: Rs 0</div>
      <button id="proceed" class="btn" disabled>Proceed</button>
    </div>
  </div>

  <script>
    const SHOW_ID = {{ show_id }};
    const USER_ID = {{ user_id }};
    // Build API/WS bases from current request (works behind proxies if scheme is set correctly)
    const API_BASE = "{{ request.url.scheme }}://{{ request.url.hostname }}{% if request.url.port %}:{{ request.url.port }}{% endif %}";
    const WS_BASE = "{{ 'wss' if request.url.scheme == 'https' else 'ws' }}://{{ request.url.hostname }}{% if request.url.port %}:{{ request.url.port }}{% endif %}";

    const selectedInfo = document.getElementById('selectedInfo');
    const totalEl = document.getElementById('total');
    const proceedBtn = document.getElementById('proceed');

    let ws = null;
    const myLocked = new Set();
    const selected = new Set();
    let extendTimer = null;

    function updateSummary() {
      const ids = Array.from(selected);
      const chips = ids.map(id => {
        const el = document.querySelector(`.seat[data-seat-id="${id}"]`);
        const label = el?.dataset.seatNumber || id;
        return `<span class="pill">${label}</span>`;
      }).join(" ");
      const count = ids.length;
      const sum = ids.reduce((acc, id) => {
        const el = document.querySelector(`.seat[data-seat-id="${id}"]`);
        const price = el ? Number(el.dataset.price || 0) : 0;
        return acc + (isNaN(price) ? 0 : price);
      }, 0);
      selectedInfo.innerHTML = count
        ? `<span class="meta">${count} seat${count>1?'s':''} selected</span> ${chips}`
        : `<span class="meta">0 seats selected</span>`;
      totalEl.textContent = `Total: Rs ${sum.toFixed(0)}`;
      proceedBtn.disabled = count === 0;
    }

    function classify(el, cls) {
      el.classList.remove('available','locked','mine','booked');
      el.classList.add(cls);
    }

    function bindSeatClicks() {
      document.querySelectorAll('.seat').forEach(el => {
        el.addEventListener('click', () => {
          const seatId = Number(el.dataset.seatId);
          const state =
            el.classList.contains('booked') ? 'booked' :
            el.classList.contains('locked') ? 'locked' :
            el.classList.contains('mine') ? 'mine' : 'available';
          if (!ws || ws.readyState !== WebSocket.OPEN) { alert("WebSocket not connected"); return; }
          if (state === 'available') {
            ws.send(JSON.stringify({ action: 'lock', seat_id: seatId, ttl: 30 }));
          } else if (state === 'mine') {
            ws.send(JSON.stringify({ action: 'unlock', seat_id: seatId }));
          }
        });
      });
    }

    function connectWS() {
      if (ws) { try { ws.close(); } catch(e){} }
      ws = new WebSocket(`${WS_BASE}/ws/seats/${SHOW_ID}?user_id=${encodeURIComponent(USER_ID)}`);
      ws.onopen = () => {
        if (extendTimer) clearInterval(extendTimer);
        extendTimer = setInterval(() => {
          if (ws.readyState !== WebSocket.OPEN) return;
          for (const id of myLocked) {
            ws.send(JSON.stringify({ action: 'extend', seat_id: id, ttl: 30 }));
          }
        }, 15000);
      };
      ws.onmessage = evt => {
        try {
          const msg = JSON.parse(evt.data);
          if (msg.type === 'seat_lock' && Number(msg.show_id) === Number(SHOW_ID)) {
            const el = document.querySelector(`.seat[data-seat-id="${msg.seat_id}"]`);
            if (!el) return;
            if (String(msg.locked_by) === String(USER_ID)) {
              myLocked.add(msg.seat_id);
              selected.add(msg.seat_id);
              classify(el,'mine');
            } else if (!myLocked.has(msg.seat_id)) {
              classify(el,'locked');
            }
            updateSummary();
          } else if (msg.type === 'seat_unlock' && Number(msg.show_id) === Number(SHOW_ID)) {
            const el = document.querySelector(`.seat[data-seat-id="${msg.seat_id}"]`);
            if (!el) return;
            myLocked.delete(msg.seat_id);
            selected.delete(msg.seat_id);
            classify(el,'available');
            updateSummary();
          } else if (msg.type === 'seat_booked' && Number(msg.show_id) === Number(SHOW_ID)) {
            for (const id of msg.seat_ids || []) {
              const el = document.querySelector(`.seat[data-seat-id="${id}"]`);
              if (!el) continue;
              classify(el,'booked');
              myLocked.delete(id);
              selected.delete(id);
            }
            updateSummary();
          }
        } catch(e) {
          console.warn("WS parse error", e);
        }
      };
      ws.onclose = () => {
        if (extendTimer) { clearInterval(extendTimer); extendTimer = null; }
      };
    }

    async function proceed() {
      const seatsArr = Array.from(selected);
      if (!seatsArr.length) return;
      const payload = {
        user_id: Number(USER_ID),
        show_id: Number(SHOW_ID),
        booking_reference: "string",
        booking_status: "PENDING",
        payment_id: 0,
        discount_id: 2,
        booking_time: new Date().toISOString(),
        amount: 0,
        seats: seatsArr,
        foods: []
      };
      const res = await fetch(`${API_BASE}/bookings/`, {
        method: "POST",
        headers: { "Content-Type":"application/json", "accept":"application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>({}));
        alert("Booking failed: " + (err.detail || res.statusText));
        return;
      }
      const data = await res.json();
      alert("Booking succeeded! ID " + data.booking_id);
    }

    document.getElementById('proceed').addEventListener('click', proceed);
    bindSeatClicks();
    updateSummary();
    connectWS();
  </script>
</body>
</html>